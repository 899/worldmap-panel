{"version":3,"sources":["../src/map_renderer.js"],"names":[],"mappings":"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","file":"map_renderer.js","sourcesContent":["import _ from 'lodash';\nimport L from './leaflet';\nimport './css/leaflet.css!';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  const mapContainer = elem.find('.mapcontainer');\n\n  ctrl.events.on('render', () => {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function render() {\n    if (!ctrl.data) return;\n\n    if (!ctrl.map) createMap();\n    resize();\n\n    if (ctrl.mapCenterMoved) panToMapCenter();\n\n    if (!ctrl.legend) createLegend();\n\n    drawCircles();\n  }\n\n  function createMap() {\n    ctrl.map = window.L.map(mapContainer[0], {worldCopyJump: true, center: [ctrl.panel.mapCenterLatitude, ctrl.panel.mapCenterLongitude]})\n      .fitWorld()\n      .zoomIn(ctrl.panel.initialZoom);\n\n    const selectedTileServer = ctrl.tileServers[ctrl.panel.tileServer];\n    window.L.tileLayer(selectedTileServer.url, {\n      maxZoom: 18,\n      subdomains: selectedTileServer.subdomains,\n      reuseTiles: true,\n      detectRetina: true,\n      attribution: selectedTileServer.attribution\n    }).addTo(ctrl.map);\n\n    ctrl.circles = [];\n  }\n\n  function createLegend() {\n    ctrl.legend = window.L.control({position: 'bottomleft'});\n    ctrl.legend.onAdd = () => {\n      ctrl.legend._div = window.L.DomUtil.create('div', 'info legend');\n      ctrl.legend.update();\n      return ctrl.legend._div;\n    };\n\n    ctrl.legend.update = () => {\n      const thresholds = ctrl.data.thresholds;\n      let legendHtml = '';\n      legendHtml += '<i style=\"background:' + ctrl.panel.colors[0] + '\"></i> ' +\n          '&lt; ' + thresholds[0] + '<br>';\n      for (let index = 0; index < thresholds.length; index++) {\n        legendHtml +=\n          '<i style=\"background:' + getColor(thresholds[index] + 1) + '\"></i> ' +\n          thresholds[index] + (thresholds[index + 1] ? '&ndash;' + thresholds[index + 1] + '<br>' : '+');\n      }\n      ctrl.legend._div.innerHTML = legendHtml;\n    };\n\n    ctrl.legend.addTo(ctrl.map);\n  }\n\n  function getColor(value) {\n    for (let index = ctrl.data.thresholds.length; index > 0; index--) {\n      if (value >= ctrl.data.thresholds[index - 1]) {\n        return ctrl.panel.colors[index];\n      }\n    }\n    return _.first(ctrl.panel.colors);\n  }\n\n  function clearCircles() {\n    ctrl.map.removeLayer(ctrl.circlesLayer);\n    ctrl.circles = [];\n  }\n\n  function drawCircles() {\n    if (ctrl.circles.length > 0 && ctrl.circles.length !== ctrl.data.length) {\n      clearCircles();\n    }\n\n    const circles = [];\n    ctrl.data.forEach(dataPoint => {\n      const location = _.find(ctrl.locations, (loc) => { return loc.key === dataPoint.key; });\n\n      if (!location) return;\n\n      const circle = _.find(ctrl.circles, cir => { return cir.options.location === location.key; });\n\n      if (circle) {\n        circle.setRadius(Math.min(ctrl.panel.circleMaxSize, Math.max(ctrl.panel.circleMinSize, (dataPoint.value || 0) * ctrl.panel.circleSizeFactor)));\n        circle.setStyle({\n          color: getColor(dataPoint.value),\n          fillColor: getColor(dataPoint.value),\n          fillOpacity: 0.5,\n          location: location.key\n        });\n        circle.unbindPopup();\n        createPopup(circle, location.name, dataPoint.valueRounded);\n      } else {\n        circles.push(createCircle(location, dataPoint));\n      }\n    });\n    ctrl.circlesLayer = window.L.layerGroup(circles).addTo(ctrl.map);\n    ctrl.circles = ctrl.circles.concat(circles);\n  }\n\n  function createCircle(location, dataPoint) {\n    const circle = window.L.circleMarker([location.latitude, location.longitude], {\n      radius: Math.min(ctrl.panel.circleMaxSize, Math.max(ctrl.panel.circleMinSize, (dataPoint.value || 0) * ctrl.panel.circleSizeFactor)),\n      color: getColor(dataPoint.value),\n      fillColor: getColor(dataPoint.value),\n      fillOpacity: 0.5,\n      location: location.key\n    });\n\n    createPopup(circle, location.name, dataPoint.valueRounded);\n    return circle;\n  }\n\n  function createPopup(circle, locationName, value) {\n    const unit = value && value === 1 ? ctrl.panel.unitSingular : ctrl.panel.unitPlural;\n    circle.bindPopup(locationName + ': ' + value + ' ' + unit, {'offset': window.L.point(0, -2), 'className': 'worldmap-popup'});\n\n    circle.on('mouseover', function (evt) {\n      const layer = evt.target;\n      layer.bringToFront();\n      this.openPopup();\n    });\n    circle.on('mouseout', function () {\n      circle.closePopup();\n    });\n  }\n\n  function resize() {\n    if (ctrl.map) ctrl.map.invalidateSize();\n  }\n\n  function panToMapCenter() {\n    ctrl.map.panTo([ctrl.panel.mapCenterLatitude, ctrl.panel.mapCenterLongitude]);\n    ctrl.mapCenterMoved = false;\n  }\n}\n"]}