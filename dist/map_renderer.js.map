{"version":3,"sources":["../src/map_renderer.js"],"names":[],"mappings":";;;;;AAGe,WAAS,IAAT,CAAc,KAAd,EAAqB,IAArB,EAA2B,KAA3B,EAAkC,IAAlC,EAAwC;AACrD,SAAK,MAAL,CAAY,EAAZ,CAAe,QAAf,EAAyB,YAAM;AAC7B,eAD6B;AAE7B,WAAK,kBAAL,GAF6B;KAAN,CAAzB,CADqD;;AAMrD,aAAS,MAAT,GAAkB;AAChB,UAAI,CAAC,KAAK,IAAL,EAAW;AACd,eADc;OAAhB;;AAIA,UAAI,CAAC,KAAK,GAAL,EAAU;AACb,oBADa;OAAf;;AAIA,eATgB;;AAWhB,UAAI,KAAK,cAAL,EAAqB;AACvB,aAAK,cAAL,GADuB;AAEvB,aAAK,cAAL,GAAsB,KAAtB,CAFuB;OAAzB;;AAKA,UAAI,KAAK,OAAL,EAAc;AAChB,aAAK,OAAL,CAAa,SAAb,CAAuB,iBAAS;AAC9B,cAAI,MAAM,UAAN,EAAkB,KAAK,OAAL,CAAa,WAAb,CAAyB,KAAzB,EAAtB;SADqB,CAAvB,CADgB;OAAlB;;AAMA,WAAK,OAAL,GAAe,EAAf,CAtBgB;AAuBhB,oBAvBgB;KAAlB;;AA0BA,aAAS,SAAT,GAAqB;AACnB,WAAK,GAAL,GAAW,OAAO,CAAP,CAAS,GAAT,CAAa,WAAW,KAAK,KAAL,CAAW,EAAX,EAAe,EAAC,eAAe,IAAf,EAAqB,QAAQ,CAAC,KAAK,KAAL,CAAW,iBAAX,EAA8B,KAAK,KAAL,CAAW,kBAAX,CAAvC,EAA7D,EACR,QADQ,GAER,MAFQ,CAED,KAAK,KAAL,CAAW,WAAX,CAFV,CADmB;;AAKnB,UAAM,qBAAqB,KAAK,KAAL,CAAW,WAAX,CAAuB,KAAK,KAAL,CAAW,UAAX,CAA5C,CALa;AAMnB,aAAO,CAAP,CAAS,SAAT,CAAmB,mBAAmB,GAAnB,EAAwB;AACzC,iBAAS,EAAT;AACA,oBAAY,mBAAmB,UAAnB;AACZ,oBAAY,IAAZ;AACA,sBAAc,IAAd;AACA,qBAAa,mBAAmB,WAAnB;OALf,EAMG,KANH,CAMS,KAAK,GAAL,CANT,CANmB;;AAcnB,oBAdmB;KAArB;;AAiBA,aAAS,WAAT,GAAuB;AACrB,UAAM,UAAU,EAAV,CADe;AAErB,WAAK,IAAL,CAAU,OAAV,CAAkB,qBAAa;AAC7B,YAAM,WAAW,EAAE,IAAF,CAAO,KAAK,SAAL,EAAgB,UAAC,GAAD,EAAS;AAAE,iBAAO,IAAI,GAAJ,KAAY,UAAU,GAAV,CAArB;SAAT,CAAlC,CADuB;;AAG7B,YAAI,CAAC,QAAD,EAAW,OAAf;;AAEA,YAAM,SAAS,OAAO,CAAP,CAAS,YAAT,CAAsB,CAAC,SAAS,QAAT,EAAmB,SAAS,SAAT,CAA1C,EAA+D;AAC5E,kBAAQ,KAAK,GAAL,CAAS,EAAT,EAAa,KAAK,GAAL,CAAS,CAAT,EAAY,CAAC,UAAU,KAAV,IAAmB,CAAnB,CAAD,GAAyB,KAAK,KAAL,CAAW,UAAX,CAAlD,CAAR;AACA,iBAAO,KAAP;AACA,qBAAW,MAAX;AACA,uBAAa,GAAb;SAJa,CAAT,CALuB;;AAY7B,eAAO,SAAP,CAAiB,SAAS,IAAT,GAAgB,IAAhB,GAAuB,UAAU,YAAV,CAAxC,CAZ6B;AAa7B,gBAAQ,IAAR,CAAa,MAAb,EAb6B;OAAb,CAAlB,CAFqB;AAiBrB,WAAK,OAAL,GAAe,OAAO,CAAP,CAAS,UAAT,CAAoB,OAApB,EAA6B,KAA7B,CAAmC,KAAK,GAAL,CAAlD,CAjBqB;KAAvB;;AAoBA,aAAS,MAAT,GAAkB;AAChB,UAAI,KAAK,GAAL,EAAU,KAAK,GAAL,CAAS,cAAT,GAAd;KADF;GArEa;;qBAAS;;;;AAHjB;;AACA","file":"map_renderer.js","sourcesContent":["import _ from 'lodash';\nimport L from './leaflet';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  ctrl.events.on('render', () => {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function render() {\n    if (!ctrl.data) {\n      return;\n    }\n\n    if (!ctrl.map) {\n      createMap();\n    }\n\n    resize();\n\n    if (ctrl.mapCenterMoved) {\n      ctrl.panToMapCenter();\n      ctrl.mapCenterMoved = false;\n    }\n\n    if (ctrl.circles) {\n      ctrl.circles.eachLayer(layer => {\n        if (layer._container) ctrl.circles.removeLayer(layer);\n      });\n    }\n\n    ctrl.circles = [];\n    drawCircles();\n  }\n\n  function createMap() {\n    ctrl.map = window.L.map('mapid_' + ctrl.panel.id, {worldCopyJump: true, center: [ctrl.panel.mapCenterLatitude, ctrl.panel.mapCenterLongitude]})\n      .fitWorld()\n      .zoomIn(ctrl.panel.initialZoom);\n\n    const selectedTileServer = ctrl.panel.tileServers[ctrl.panel.tileServer];\n    window.L.tileLayer(selectedTileServer.url, {\n      maxZoom: 18,\n      subdomains: selectedTileServer.subdomains,\n      reuseTiles: true,\n      detectRetina: true,\n      attribution: selectedTileServer.attribution\n    }).addTo(ctrl.map);\n\n    drawCircles();\n  }\n\n  function drawCircles() {\n    const circles = [];\n    ctrl.data.forEach(dataPoint => {\n      const location = _.find(ctrl.locations, (loc) => { return loc.key === dataPoint.key; });\n\n      if (!location) return;\n\n      const circle = window.L.circleMarker([location.latitude, location.longitude], {\n        radius: Math.min(10, Math.max(1, (dataPoint.value || 0) * ctrl.panel.circleSize)),\n        color: 'red',\n        fillColor: '#f03',\n        fillOpacity: 0.5\n      });\n\n      circle.bindPopup(location.name + ': ' + dataPoint.valueRounded);\n      circles.push(circle);\n    });\n    ctrl.circles = window.L.layerGroup(circles).addTo(ctrl.map);\n  }\n\n  function resize() {\n    if (ctrl.map) ctrl.map.invalidateSize();\n  }\n}\n"]}